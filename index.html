<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PushGoal WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: #f2f2f2;
      min-height: 100vh;
    }
    .top-bar {
      width: 100%;
      display: flex;
      justify-content: flex-end;
      padding: 10px;
    }
    .top-bar button {
      background: none;
      border: none;
      color: #007bff;
      font-size: 14px;
      cursor: pointer;
    }
    .content {
      padding: 20px;
      text-align: center;
      width: 100%;
      max-width: 400px;
    }
    .btn {
      width: 200px;
      height: 200px;
      border-radius: 100px;
      border: none;
      font-size: 18px;
      color: white;
      margin: 40px auto 20px auto;
      opacity: 0.1;
      transition: opacity 0.3s ease, background 0.3s ease;
    }
    input, select {
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      width: 100%;
      max-width: 300px;
    }
    #goalDisplay {
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button id="resetBtn" onclick="resetGoal()" style="display: none;">–ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–ª—å</button>
  </div>
  <div class="content">
    <div id="setupForm">
      <h2>–ù–∞—Å—Ç—Ä–æ–π —Ü–µ–ª—å</h2>
      <input id="goal" type="text" placeholder="–í–≤–µ–¥–∏ —Ü–µ–ª—å" />
      <select id="color">
        <option value="#FF5733">–ö—Ä–∞—Å–Ω—ã–π</option>
        <option value="#33C1FF">–°–∏–Ω–∏–π</option>
        <option value="#75FF33">–ó–µ–ª—ë–Ω—ã–π</option>
        <option value="#F033FF">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
      </select>
      <input id="steps" type="number" min="2" max="30" value="10" placeholder="–®–∞–≥–æ–≤ –¥–æ —Ü–µ–ª–∏" />
      <button onclick="saveData()">üöÄ –ù–∞—á–∞—Ç—å</button>
    </div>

    <div id="progressSection" style="display:none;">
      <div id="goalDisplay"></div>
      <button id="goalBtn" class="btn">0%</button>
    </div>
  </div>

  <script>
    let progress = 0;
    let total = 10;
    let selectedColor = '#33C1FF';
    let currentGoal = '';

    function saveData() {
      currentGoal = document.getElementById("goal").value;
      selectedColor = document.getElementById("color").value;
      total = parseInt(document.getElementById("steps").value);

      Telegram.WebApp.sendData(JSON.stringify({
        goal: currentGoal,
        color: selectedColor,
        steps_total: total
      }));

      progress = 0;
      localStorage.setItem("pushgoalData", JSON.stringify({ currentGoal, selectedColor, total, progress }));
      applyState();
    }

    function updateButton() {
      const btn = document.getElementById("goalBtn");
      const percent = Math.min(100, Math.round((progress / total) * 100));
      btn.innerText = percent < 100 ? `${percent}%` : "üéØ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!";
      btn.style.opacity = 0.1 + 0.9 * (progress / total);
      btn.style.background = selectedColor;
    }

    function resetGoal() {
      localStorage.removeItem("pushgoalData");
      location.reload();
    }

    document.getElementById("goalBtn").addEventListener("click", () => {
      if (progress < total) {
        progress++;
        localStorage.setItem("pushgoalData", JSON.stringify({ currentGoal, selectedColor, total, progress }));
        updateButton();
      }
    });

    function applyState() {
      try {
        const raw = localStorage.getItem("pushgoalData");
        if (!raw) return;

        const data = JSON.parse(raw);
        if (!data.currentGoal || !data.selectedColor || !data.total) return;

        currentGoal = data.currentGoal;
        selectedColor = data.selectedColor;
        total = data.total;
        progress = data.progress ?? 0;

        document.getElementById("setupForm").style.display = "none";
        document.getElementById("progressSection").style.display = "block";
        document.getElementById("resetBtn").style.display = "inline";
        document.getElementById("goalDisplay").innerText = currentGoal;
        updateButton();
      } catch (e) {
        console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –¥–∞–Ω–Ω—ã—Ö:", e);
        localStorage.removeItem("pushgoalData");
      }
    }

    Telegram.WebApp.ready();
    applyState();
  </script>
</body>
</html>
